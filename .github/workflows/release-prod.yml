name: ReleaseLens - Prod Deploy (Manual, Med/High)

on:
  workflow_dispatch:
    inputs:
      git_tag:
        description: 'Tag to deploy (e.g. sandbox-service-v0.2.0)'
        required: true
      change_key:
        description: 'Jira Change key (e.g. CHGTEST-2)'
        required: true

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    env:
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag exists
        run: |
          git fetch --tags
          if ! git rev-parse "${{ github.event.inputs.git_tag }}" >/dev/null 2>&1; then
            echo "Tag not found: ${{ github.event.inputs.git_tag }}"
            exit 1
          fi
          echo "Tag exists."

      - name: Get risk level from Jira Change
        id: jira
        run: |
          CHANGE_KEY="${{ github.event.inputs.change_key }}"
          RESPONSE=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${CHANGE_KEY}?fields=customfield_10003,status")
          
          echo "Jira response: $RESPONSE"
          RISK=$(echo "$RESPONSE" | jq -r '.fields.customfield_10003') # Risk level field
          STATUS_NAME=$(echo "$RESPONSE" | jq -r '.fields.status.name')

          echo "risk_level=$RISK" >> $GITHUB_OUTPUT
          echo "status_name=$STATUS_NAME" >> $GITHUB_OUTPUT

          # Enforce that for medium/high, Jira status must be 'Approved for Prod'
          if [ "$RISK" = "medium" ] || [ "$RISK" = "high" ]; then
            if [ "$STATUS_NAME" != "Approved for Prod" ]; then
              echo "Change ${CHANGE_KEY} is $RISK risk and not Approved for Prod (current status: $STATUS_NAME). Aborting."
              exit 1
            fi
          else
            echo "Risk is $RISK; this workflow is intended for medium/high. Proceeding anyway for test."
          fi

      - name: FAKE Prod Deploy (manual)
        run: |
          echo "=== FAKE PROD DEPLOYMENT (MANUAL, MED/HIGH TEST) ==="
          echo "Would deploy tag ${{ github.event.inputs.git_tag }} to PRODUCTION."
          sleep 5
          echo "Fake prod deployment complete."

      - name: Transition Jira Change to Completed
        run: |
          CHANGE_KEY="${{ github.event.inputs.change_key }}"

          TRANSITIONS=$(curl -s -X GET \
            -H "Content-Type: application/json" \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${CHANGE_KEY}/transitions")

          COMPLETE_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.to.name=="Completed") | .id')

          if [ -z "$COMPLETE_ID" ]; then
            echo "No 'Completed' transition found for ${CHANGE_KEY}"
            exit 1
          fi

          curl -s -X POST \
            -H "Content-Type: application/json" \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            "${JIRA_BASE_URL}/rest/api/3/issue/${CHANGE_KEY}/transitions" \
            --data "{\"transition\": {\"id\": \"$COMPLETE_ID\"}}"

      - name: Post Slack notification (prod â€“ manual)
        if: always()
        run: |
          STATUS="SUCCESS"
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="FAILED"
          fi

          text="*Production Deployment (Manual, Med/High, TEST) ${STATUS}*\n\
          Tag: \`${{ github.event.inputs.git_tag }}\`\n\
          Change: \`${{ github.event.inputs.change_key }}\`\n\
          Risk: \`${{ steps.jira.outputs.risk_level }}\`\n\
          Run: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$text\"}" \
            "$SLACK_WEBHOOK_URL"